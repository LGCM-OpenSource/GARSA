help(png)
library(bigsnpr)
options(bigstatsr.check.parallel.blas = FALSE)
options(default.nproc.blas = NULL)
library(data.table)
library(magrittr)
library(ggplot2)
library(optparse)
##Read in the phenotype, covariate and pcs files
bfile = "/home/fernando/lgcm/projects/Pipeline_FOXCONN/dev/scripts/testes_pipe/tmp/GARSA_final_example_for_LDPRED.bed"
mlma = "/home/fernando/lgcm/projects/Pipeline_FOXCONN/dev/scripts/testes_pipe/tmp/GARSA_final_example_GCTA_qcovar_covar_GWAS.adjusted.mlma"
pheno_file = "/home/fernando/lgcm/projects/Pipeline_FOXCONN/dev/scripts/testes_pipe/GARSA_example_phenotype.tsv"
covar = "/home/fernando/lgcm/projects/Pipeline_FOXCONN/dev/scripts/testes_pipe/GARSA_example_covar.tsv"
qcovar = "/home/fernando/lgcm/projects/Pipeline_FOXCONN/dev/scripts/testes_pipe/GARSA_final_example_PCA_total.txt"
database = "/home/fernando/lgcm/projects/Pipeline_FOXCONN/dev/scripts/Final/modules/database/LDPRED2/map_hm3_ldpred2.rds"
out_dir = "/home/fernando/lgcm/projects/Pipeline_FOXCONN/dev/scripts/testes_pipe/"
n_pcs = 4
threads = 4
#Phenotype --> mesma tabela de fenotipos do GWAS
phenotype <- read.table(pheno_file, header=TRUE,
)
colnames(phenotype) = c("FID", "IID", "Pheno")
#Tabela de covars do GWAS
covariate <- read.table(covar,
header = TRUE)
#Tabela de qcovars do GWAS -- Aqui como temos apenas 4 PCs, pegamos as colunas de FID e IID + PC1 .. PC4
pcs <- read.table(qcovar,
header = TRUE)
##Gerando a tabela necessária para seguir em frente
pheno <- merge(phenotype, covariate) %>%
merge(., pcs)
##HapMapSNPs
info <- readRDS(database)
#Load Summary file do GWAS
sumstats <- bigreadr::fread2(mlma)
# Filter out hapmap SNPs
print("Filtering SNPs using Reference -- database")
sumstats <- sumstats[sumstats$rsid%in% info$rsid,]
print(paste0(length(sumstats$rsid), " SNPs will be used for the LDPRED analysis"))
## Calculate the LD matrix ##
NCORES <- threads
# Open a temporary file
tmp <- tempfile(tmpdir = out_dir)
on.exit(file.remove(paste0(tmp, ".sbk")), add = TRUE)
# Initialize variables for storing the LD score and LD matrix
corr <- NULL
ld <- NULL
# We want to know the ordering of samples in the bed file
fam.order <- NULL
# preprocess the bed file (only need to do once for each data set)
snp_readBed(bfile)
bfile_rds =gsub(".bed", ".rds", bfile)
# now attach the genotype object
obj.bigSNP <- snp_attach(bfile_rds)
# extract the SNP information from the genotype
map <- obj.bigSNP$map[-3]
names(map) <- c("chr", "rsid", "pos", "a1", "a0")
# perform SNP matching
info_snp <- snp_match(sumstats, map,join_by_pos = FALSE)
# Assign the genotype to a variable for easier downstream analysis
genotype <- obj.bigSNP$genotypes
#imputation in genotype file, because it can't contains NA values
#genotype_2 <- snp_fastImputeSimple(genotype, ncores = NCORES)
# Rename the data structures
CHR <- map$chr
POS <- map$pos
# get the CM information from 1000 Genome
# will download the 1000G file to the current directory (".")
POS2 <- snp_asGeneticPos(CHR, POS, dir = out_dir)
#limpar um pouco da memória
gc()
# calculate LD
for (chr in 1:22) {
# Extract SNPs that are included in the chromosome
ind.chr <- which(info_snp$chr == chr)
ind.chr2 <- info_snp$`_NUM_ID_`[ind.chr]
# Calculate the LD
corr0 <- snp_cor(
genotype,
ind.col = ind.chr2,
ncores = NCORES,
infos.pos = POS2[ind.chr2],
size = 3 / 1000
)
if (chr == 1) {
ld <- Matrix::colSums(corr0^2)
corr <- as_SFBM(corr0, tmp)
} else {
ld <- c(ld, Matrix::colSums(corr0^2))
corr$add_columns(corr0, nrow(corr))
}
}
warnings()
chr=1
# Extract SNPs that are included in the chromosome
ind.chr <- which(info_snp$chr == chr)
ind.chr
ind.chr2 <- info_snp$`_NUM_ID_`[ind.chr]
ind.chr2
# Calculate the LD
corr0 <- snp_cor(
genotype,
ind.col = ind.chr2,
ncores = NCORES,
infos.pos = POS2[ind.chr2],
size = 3 / 1000
)
corr0
ind.chr2
is.na(ind.chr2)
table(is.na(ind.chr2))
table(is.na(ind.chr))
ld <- Matrix::colSums(corr0^2)
corr <- as_SFBM(corr0, tmp)
ld <- Matrix::colSums(corr0^2)
corr <- as_SFBM(corr0, tmp)
ld
Matrix::colSums(corr0^2)
corr0
genotype
str(genotype)
obj.bigSNP$genotypes
obj.bigSNP
obj.bigSNP$genotypes
str(obj.bigSNP$genotypes)
str(obj.bigSNP$genotypes$code256)
ind.chr2
corr0
ind.chr2
genotype
genotype$code256
obj.bigSNP$map[-3]
#imputation in genotype file, because it can't contains NA values
genotype_2 <- snp_fastImputeSimple(genotype, ncores = NCORES)
genotype_2
genotype_2$code256
obj.bigSNP$map[-3]
obj.bigSNP$map
obj.bigSNP$genotypes
snp_attach(bfile_rds)
obj.bigSNP$genotypes
obj.bigSNP$genotypes$code256
View(obj.bigSNP)
View(info_snp)
table(is.na(info_snp))
library(tidyverse)
info_snp <- drop_na(info_snp)
info_snp
# Assign the genotype to a variable for easier downstream analysis
genotype <- obj.bigSNP$genotypes
genotype
genotype$code256
info_snp
sumstats <- sumstats[sumstats$rsid%in% info$rsid,]
print(paste0(length(sumstats$rsid), " SNPs will be used for the LDPRED analysis"))
# perform SNP matching
info_snp <- snp_match(sumstats, map,join_by_pos = FALSE)
obj.bigSNP$genotypes
obj.bigSNP
str(obj.bigSNP$genotypes)
# We assume the fam order is the same across different chromosomes
fam.order <- as.data.table(obj.bigSNP$fam)
# Rename fam order
setnames(fam.order,
c("family.ID", "sample.ID"),
c("FID", "IID"))
ldsc <- snp_ldsc( ld,
length(ld),
chi2 = (df_beta$beta / df_beta$beta_se)^2,
sample_size = df_beta$n_eff,
blocks = NULL)
df_beta <- info_snp[,c("beta", "beta_se", "n_eff", "_NUM_ID_")]
ldsc <- snp_ldsc( ld,
length(ld),
chi2 = (df_beta$beta / df_beta$beta_se)^2,
sample_size = df_beta$n_eff,
blocks = NULL)
# ldsc <- snp_ldsc( ld,
#                   length(ld),
#                   chi2 = (df_beta$beta / df_beta$beta_se)^2,
#                   sample_size = df_beta$n_eff,
#                   blocks = NULL)
ldsc <- snp_ldsc2(corr, df_beta)
ldsc <- snp_ldsc( ld,
length(ld),
chi2 = (df_beta$beta / df_beta$beta_se)^2,
sample_size = df_beta$n_eff,
blocks = NULL)
View(fam.order)
View(covariate)
View(pcs)
View(pheno)
View(phenotype)
View(sumstats)
table(is.na(df_beta))
table(is.na(df_beta$beta))
View(df_beta)
library(dplyr)
df_beta <- drop_na(df_beta)
ldsc <- snp_ldsc( ld,
length(ld),
chi2 = (df_beta$beta / df_beta$beta_se)^2,
sample_size = df_beta$n_eff,
blocks = NULL)
df_beta <- info_snp[,c("beta", "beta_se", "n_eff", "_NUM_ID_")]
df_beta[is.na(df_beta)] <- 0
ldsc <- snp_ldsc( ld,
length(ld),
chi2 = (df_beta$beta / df_beta$beta_se)^2,
sample_size = df_beta$n_eff,
blocks = NULL)
df_beta <- info_snp[,c("beta", "beta_se", "n_eff", "_NUM_ID_")]
# df_beta[is.na(df_beta)] <- 0
ldsc <- snp_ldsc( ld,
length(ld),
chi2 = (df_beta$beta / df_beta$beta_se)^2,
sample_size = df_beta$n_eff,
blocks = NULL)
gc()
library(bigsnpr)
options(bigstatsr.check.parallel.blas = FALSE)
options(default.nproc.blas = NULL)
library(data.table)
library(magrittr)
library(ggplot2)
library(optparse)
library(dplyr)
##Read in the phenotype, covariate and pcs files
bfile = "/home/fernando/lgcm/projects/Pipeline_FOXCONN/dev/scripts/testes_pipe/tmp/GARSA_final_example_for_LDPRED.bed"
mlma = "/home/fernando/lgcm/projects/Pipeline_FOXCONN/dev/scripts/testes_pipe/tmp/GARSA_final_example_GCTA_qcovar_covar_GWAS.adjusted.mlma"
pheno_file = "/home/fernando/lgcm/projects/Pipeline_FOXCONN/dev/scripts/testes_pipe/GARSA_example_phenotype.tsv"
covar = "/home/fernando/lgcm/projects/Pipeline_FOXCONN/dev/scripts/testes_pipe/GARSA_example_covar.tsv"
qcovar = "/home/fernando/lgcm/projects/Pipeline_FOXCONN/dev/scripts/testes_pipe/GARSA_final_example_PCA_total.txt"
database = "/home/fernando/lgcm/projects/Pipeline_FOXCONN/dev/scripts/Final/modules/database/LDPRED2/map_hm3_ldpred2.rds"
out_dir = "/home/fernando/lgcm/projects/Pipeline_FOXCONN/dev/scripts/testes_pipe/"
n_pcs = 4
threads = 4
phenotype <- read.table(pheno_file, header=TRUE,
)
colnames(phenotype) = c("FID", "IID", "Pheno")
covariate <- read.table(covar,
header = TRUE)
pcs <- read.table(qcovar,
header = TRUE)
pheno <- merge(phenotype, covariate) %>%
merge(., pcs)
info <- readRDS(database)
View(info)
sumstats <- bigreadr::fread2(mlma)
View(sumstats)
sumstats <- sumstats[sumstats$rsid%in% info$rsid,]
NCORES <- threads
# Open a temporary file
tmp <- tempfile(tmpdir = out_dir)
out_dir = "/home/fernando/lgcm/projects/Pipeline_FOXCONN/dev/scripts/testes_pipe"
# Open a temporary file
tmp <- tempfile(tmpdir = out_dir)
on.exit(file.remove(paste0(tmp, ".sbk")), add = TRUE)
# Initialize variables for storing the LD score and LD matrix
corr <- NULL
ld <- NULL
# We want to know the ordering of samples in the bed file
fam.order <- NULL
# preprocess the bed file (only need to do once for each data set)
snp_readBed(bfile)
# now attach the genotype object
obj.bigSNP <- snp_attach(bfile_rds)
# now attach the genotype object
obj.bigSNP <- snp_attach(bfile_rds)
# preprocess the bed file (only need to do once for each data set)
snp_readBed(bfile)
# now attach the genotype object
obj.bigSNP <- snp_attach(bfile_rds)
bfile_rds =gsub(".bed", ".rds", bfile)
# now attach the genotype object
obj.bigSNP <- snp_attach(bfile_rds)
map <- obj.bigSNP$map[-3]
names(map) <- c("chr", "rsid", "pos", "a1", "a0")
# perform SNP matching
info_snp <- snp_match(sumstats, map,join_by_pos = FALSE)
View(info_snp)
# info_snp <- drop_na(info_snp)
# Assign the genotype to a variable for easier downstream analysis
genotype <- obj.bigSNP$genotypes
table(is.na(info))
table(is.na(pheno))
table(is.na(info))
View(info)
info <- drop_na(info)
sumstats <- bigreadr::fread2(mlma)
sumstats <- sumstats[sumstats$rsid%in% info$rsid,]
NCORES <- threads
# Open a temporary file
tmp <- tempfile(tmpdir = out_dir)
on.exit(file.remove(paste0(tmp, ".sbk")), add = TRUE)
corr <- NULL
ld <- NULL
# We want to know the ordering of samples in the bed file
fam.order <- NULL
# preprocess the bed file (only need to do once for each data set)
snp_readBed(bfile)
# preprocess the bed file (only need to do once for each data set)
snp_readBed(bfile)
# now attach the genotype object
obj.bigSNP <- snp_attach(bfile_rds)
map <- obj.bigSNP$map[-3]
names(map) <- c("chr", "rsid", "pos", "a1", "a0")
# perform SNP matching
info_snp <- snp_match(sumstats, map,join_by_pos = FALSE)
# Rename the data structures
CHR <- map$chr
POS <- map$pos
# get the CM information from 1000 Genome
# will download the 1000G file to the current directory (".")
POS2 <- snp_asGeneticPos(CHR, POS, dir = out_dir)
#limpar um pouco da memória
gc()
# calculate LD
for (chr in 1:22) {
# Extract SNPs that are included in the chromosome
ind.chr <- which(info_snp$chr == chr)
ind.chr2 <- info_snp$`_NUM_ID_`[ind.chr]
# Calculate the LD
corr0 <- snp_cor(
genotype,
ind.col = ind.chr2,
ncores = NCORES,
infos.pos = POS2[ind.chr2],
size = 3 / 1000
)
if (chr == 1) {
ld <- Matrix::colSums(corr0^2)
corr <- as_SFBM(corr0, tmp)
} else {
ld <- c(ld, Matrix::colSums(corr0^2))
corr$add_columns(corr0, nrow(corr))
}
}
# We assume the fam order is the same across different chromosomes
fam.order <- as.data.table(obj.bigSNP$fam)
# Rename fam order
setnames(fam.order,
c("family.ID", "sample.ID"),
c("FID", "IID"))
df_beta <- info_snp[,c("beta", "beta_se", "n_eff", "_NUM_ID_")]
# df_beta[is.na(df_beta)] <- 0
ldsc <- snp_ldsc( ld,
length(ld),
chi2 = (df_beta$beta / df_beta$beta_se)^2,
sample_size = df_beta$n_eff,
blocks = NULL)
table(is.na(info_sno))
table(is.na(info_snp))
table(is.na(df_beta$beta))
sumstats <- bigreadr::fread2(mlma)
table(is.na(sumstats))
View(sumstats)
gc()
library(bigsnpr)
options(bigstatsr.check.parallel.blas = FALSE)
options(default.nproc.blas = NULL)
library(data.table)
library(magrittr)
library(ggplot2)
library(optparse)
library(dplyr)
##Read in the phenotype, covariate and pcs files
bfile = "/home/fernando/lgcm/projects/Pipeline_FOXCONN/dev/scripts/testes_pipe/tmp/GARSA_final_example_for_LDPRED.bed"
mlma = "/home/fernando/lgcm/projects/Pipeline_FOXCONN/dev/scripts/testes_pipe/tmp/GARSA_final_example_GCTA_qcovar_covar_GWAS.adjusted.mlma"
pheno_file = "/home/fernando/lgcm/projects/Pipeline_FOXCONN/dev/scripts/testes_pipe/GARSA_example_phenotype.tsv"
covar = "/home/fernando/lgcm/projects/Pipeline_FOXCONN/dev/scripts/testes_pipe/GARSA_example_covar.tsv"
qcovar = "/home/fernando/lgcm/projects/Pipeline_FOXCONN/dev/scripts/testes_pipe/GARSA_final_example_PCA_total.txt"
database = "/home/fernando/lgcm/projects/Pipeline_FOXCONN/dev/scripts/Final/modules/database/LDPRED2/map_hm3_ldpred2.rds"
out_dir = "/home/fernando/lgcm/projects/Pipeline_FOXCONN/dev/scripts/testes_pipe"
n_pcs = 4
threads = 4
#Phenotype --> mesma tabela de fenotipos do GWAS
phenotype <- read.table(pheno_file, header=TRUE,
)
colnames(phenotype) = c("FID", "IID", "Pheno")
#Tabela de covars do GWAS
covariate <- read.table(covar,
header = TRUE)
#Tabela de qcovars do GWAS -- Aqui como temos apenas 4 PCs, pegamos as colunas de FID e IID + PC1 .. PC4
pcs <- read.table(qcovar,
header = TRUE)
##Gerando a tabela necessária para seguir em frente
pheno <- merge(phenotype, covariate) %>%
merge(., pcs)
##HapMapSNPs
info <- readRDS(database)
info <- drop_na(info)
#Load Summary file do GWAS
sumstats <- bigreadr::fread2(mlma)
sumstats <- drop_na(sumstats)
# Filter out hapmap SNPs
print("Filtering SNPs using Reference -- database")
sumstats <- sumstats[sumstats$rsid%in% info$rsid,]
print(paste0(length(sumstats$rsid), " SNPs will be used for the LDPRED analysis"))
## Calculate the LD matrix ##
NCORES <- threads
# Open a temporary file
tmp <- tempfile(tmpdir = out_dir)
on.exit(file.remove(paste0(tmp, ".sbk")), add = TRUE)
# Initialize variables for storing the LD score and LD matrix
corr <- NULL
ld <- NULL
# We want to know the ordering of samples in the bed file
fam.order <- NULL
# preprocess the bed file (only need to do once for each data set)
snp_readBed(bfile)
bfile_rds =gsub(".bed", ".rds", bfile)
# now attach the genotype object
obj.bigSNP <- snp_attach(bfile_rds)
# extract the SNP information from the genotype
map <- obj.bigSNP$map[-3]
names(map) <- c("chr", "rsid", "pos", "a1", "a0")
# perform SNP matching
info_snp <- snp_match(sumstats, map,join_by_pos = FALSE)
# info_snp <- drop_na(info_snp)
# Assign the genotype to a variable for easier downstream analysis
genotype <- obj.bigSNP$genotypes
# Rename the data structures
CHR <- map$chr
POS <- map$pos
# get the CM information from 1000 Genome
# will download the 1000G file to the current directory (".")
POS2 <- snp_asGeneticPos(CHR, POS, dir = out_dir)
#limpar um pouco da memória
gc()
# calculate LD
for (chr in 1:22) {
# Extract SNPs that are included in the chromosome
ind.chr <- which(info_snp$chr == chr)
ind.chr2 <- info_snp$`_NUM_ID_`[ind.chr]
# Calculate the LD
corr0 <- snp_cor(
genotype,
ind.col = ind.chr2,
ncores = NCORES,
infos.pos = POS2[ind.chr2],
size = 3 / 1000
)
if (chr == 1) {
ld <- Matrix::colSums(corr0^2)
corr <- as_SFBM(corr0, tmp)
} else {
ld <- c(ld, Matrix::colSums(corr0^2))
corr$add_columns(corr0, nrow(corr))
}
}
# We assume the fam order is the same across different chromosomes
fam.order <- as.data.table(obj.bigSNP$fam)
# Rename fam order
setnames(fam.order,
c("family.ID", "sample.ID"),
c("FID", "IID"))
df_beta <- info_snp[,c("beta", "beta_se", "n_eff", "_NUM_ID_")]
# df_beta[is.na(df_beta)] <- 0
ldsc <- snp_ldsc( ld,
length(ld),
chi2 = (df_beta$beta / df_beta$beta_se)^2,
sample_size = df_beta$n_eff,
blocks = NULL)
